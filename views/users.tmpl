{{ define "users" }}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="/img/logo.ico">
    <title>SparkProxy â€¢ Users</title>
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/sidebar.css" />
    <link rel="stylesheet" href="/css/users.css" />
</head>

<body class="page-users">
    <div class="app">
        {{ template "sidebar" . }}
        {{ template "notifications" . }}

        <main class="content" role="main" aria-labelledby="page-title">
            <header class="page-header">
                <h1 id="page-title">Manage Users</h1>
                <p class="subtitle">Invite and manage users with access to this organization</p>
            </header>

            <section class="panel" aria-label="Users">
                <div class="toolbar">
                    <div class="left">
                        <label class="input-icon" aria-label="Search users">
                            <span class="icon" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"></circle>
                                    <path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                            <input type="search" placeholder="Search users...">
                        </label>
                    </div>
                    <div class="right">
                        <button class="btn ghost" type="button" id="refresh-users-btn">
                            <span class="icon orange" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="2"></path>
                                    <path d="M21 3v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                            <span>Refresh</span>
                        </button>
                        <button class="btn ghost" type="button" id="open-invite-modal">
                            <span class="icon orange" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                            <span>Invite User</span>
                        </button>
                    </div>
                </div>

                <div class="table-wrap">
                    <table class="table users-table" role="grid">
                        <thead>
                            <tr>
                                <th scope="col">Username</th>
                                <th scope="col">Identity Provider</th>
                                <th scope="col">Role</th>
                                <th scope="col">Access</th>
                                <th scope="col">Domains</th>
                                <th scope="col"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Users will be populated from /api/users -->
                        </tbody>
                    </table>
                </div>

                <div class="pager">
                    <div class="page-info">Page 1 of 1</div>
                    <div class="page-controls">
                        <button class="btn small ghost" aria-label="First page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M18 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                    <path d="M12 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" aria-label="Previous page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" aria-label="Next page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" aria-label="Last page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M6 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                    <path d="M12 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal-backdrop" id="invite-modal" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="invite-title">
            <div class="user-form">
                <h2 id="invite-title">Invite User</h2>
                <form id="user-form">
                    <div class="field-row">
                        <label>
                            <span>Username</span>
                            <input type="text" name="username" required />
                        </label>
                        <label>
                            <span>Email</span>
                            <input type="email" name="email" required />
                        </label>
                        <label>
                            <span>Password</span>
                            <input type="password" name="password" required />
                        </label>
                    </div>
                    <div class="field-row">
                        <label>
                            <span>Role</span>
                            <select name="role">
                                <option value="Owner">Owner</option>
                                <option value="Admin">Admin</option>
                                <option value="Member" selected>Member</option>
                            </select>
                        </label>
                        <label>
                            <span>Access</span>
                            <select name="access_type" id="user-access-type">
                                <option value="all" selected>All domains</option>
                                <option value="custom">Custom domains</option>
                            </select>
                        </label>
                        <label class="domains-field" id="domains-field" hidden>
                            <span>Allowed domains</span>
                            <select name="domains" id="user-domains" multiple size="4"></select>
                        </label>
                    </div>
                    <div class="actions-row">
                        <button class="btn primary" type="submit">Create user</button>
                        <button class="btn ghost" type="button" id="invite-cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const accessSel = document.getElementById('user-access-type');
            const domainsField = document.getElementById('domains-field');
            const domainsSelect = document.getElementById('user-domains');
            const form = document.getElementById('user-form');
            const tableBody = document.querySelector('.users-table tbody');
            const searchInput = document.querySelector('.toolbar .input-icon input[type="search"]');
            const refreshBtn = document.getElementById('refresh-users-btn');
            const openInviteBtn = document.getElementById('open-invite-modal');
            const inviteModal = document.getElementById('invite-modal');
            const inviteCancelBtn = document.getElementById('invite-cancel-btn');

            let allUsers = [];
            let allDomains = [];

            function openModal() {
                if (!inviteModal) return;
                inviteModal.hidden = false;
            }

            function closeModal() {
                if (!inviteModal) return;
                inviteModal.hidden = true;
                if (form) {
                    form.reset();
                }
                if (accessSel) {
                    accessSel.value = 'all';
                }
                updateDomainsVisibility();
            }

            function updateDomainsVisibility() {
                if (!accessSel || !domainsField) return;
                const val = accessSel.value || 'all';
                domainsField.hidden = val !== 'custom';
            }

            function populateDomainOptions() {
                if (!domainsSelect) return;
                domainsSelect.innerHTML = '';
                allDomains.forEach(function (d) {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    domainsSelect.appendChild(opt);
                });
            }

            function renderUsers() {
                if (!tableBody) return;
                const term = (searchInput && searchInput.value || '').toLowerCase();
                tableBody.innerHTML = '';
                allUsers
                    .filter(function (u) {
                        if (!term) return true;
                        const hay = (u.username + ' ' + (u.email || '') + ' ' + (u.role || '')).toLowerCase();
                        return hay.indexOf(term) !== -1;
                    })
                    .forEach(function (u) {
                        const tr = document.createElement('tr');

                        function td(text) {
                            const cell = document.createElement('td');
                            cell.textContent = text || '';
                            return cell;
                        }

                        tr.appendChild(td(u.username));
                        tr.appendChild(td(u.identity_provider || 'Local'));
                        tr.appendChild(td(u.role || 'Member'));
                        tr.appendChild(td(u.access_type === 'custom' ? 'Custom' : 'All domains'));
                        tr.appendChild(td((u.domains || []).join(', ')));

                        const actions = document.createElement('td');
                        const delBtn = document.createElement('button');
                        delBtn.type = 'button';
                        delBtn.className = 'btn small ghost';
                        delBtn.textContent = 'Remove';
                        delBtn.addEventListener('click', function () {
                            if (!confirm('Remove user ' + u.username + '?')) return;
                            fetch('/api/users/' + encodeURIComponent(u.username), { method: 'DELETE' })
                                .then(function (r) { return r.json(); })
                                .then(function () { loadUsers(); })
                                .catch(function (err) { console.error('Failed to delete user', err); });
                        });
                        actions.appendChild(delBtn);
                        tr.appendChild(actions);

                        tableBody.appendChild(tr);
                    });
            }

            function loadUsers() {
                fetch('/api/users')
                    .then(function (r) { return r.ok ? r.json() : Promise.reject(r); })
                    .then(function (data) {
                        allUsers = (data && data.users) || [];
                        renderUsers();
                    })
                    .catch(function (err) {
                        console.error('Failed to load /api/users', err);
                        if (typeof showToast === 'function') {
                            showToast('Failed to load users');
                        } else if (typeof alert === 'function') {
                            alert('Failed to load users');
                        }
                    });
            }

            function loadDomains() {
                fetch('/api/proxys')
                    .then(function (r) { return r.ok ? r.json() : Promise.reject(r.status); })
                    .then(function (data) {
                        const cfgs = (data && data.configs) || [];
                        allDomains = cfgs.map(function (c) { return c.domain; });
                        populateDomainOptions();
                    })
                    .catch(function (err) { console.error('Failed to load /api/proxys', err); });
            }

            if (accessSel) {
                accessSel.addEventListener('change', updateDomainsVisibility);
                updateDomainsVisibility();
            }

            if (openInviteBtn) {
                openInviteBtn.addEventListener('click', function () {
                    openModal();
                });
            }

            if (inviteCancelBtn) {
                inviteCancelBtn.addEventListener('click', function () {
                    closeModal();
                });
            }

            if (inviteModal) {
                inviteModal.addEventListener('click', function (e) {
                    if (e.target === inviteModal) {
                        closeModal();
                    }
                });
            }

                              if (form) {
                        form.addEventListener('submit', function (e) {
                            e.preventDefault();
                            const formData = new FormData(form);
                            const username = formData.get('username');
                            const email = formData.get('email');
                            const password = formData.get('password');
                            const role = formData.get('role') || 'Member';
                            const accessType = formData.get('access_type') || 'all';
                            var domains = [];
                            if (accessType === 'custom' && domainsSelect) {
                                Array.prototype.forEach.call(domainsSelect.selectedOptions || [], function (opt) {
                                    domains.push(opt.value);
                                });
                            }

                            fetch('/api/users', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    username: username,
                                    email: email,
                                    password: password,
                                    role: role,
                                    access_type: accessType,
                                    domains: domains
                                })
                            })
                                .then(function (r) {
                                    var ct = r.headers.get('content-type') || '';
                                    if (!ct.includes('application/json')) {
                                        return r.text().then(function () {
                                            var msg = 'Unexpected response from server';
                                            if (typeof showToast === 'function') {
                                                showToast(msg);
                                            } else if (typeof alert === 'function') {
                                                alert(msg);
                                            }
                                            throw new Error(msg);
                                        });
                                    }
                                    return r.json().then(function (data) {
                                        if (!r.ok || (data && data.error)) {
                                            var msg2 = (data && data.error) || 'Failed to create user';
                                            if (typeof showToast === 'function') {
                                                showToast(msg2);
                                            } else if (typeof alert === 'function') {
                                                alert(msg2);
                                            }
                                            throw new Error(msg2);
                                        }
                                        return data;
                                    });
                                })
                                .then(function () {
                                    closeModal();
                                    if (typeof showToast === 'function') {
                                        showToast('User created successfully');
                                    }
                                    loadUsers();
                                })
                                .catch(function (err) {
                                    console.error('Failed to create user', err);
                                    if (typeof showToast === 'function') {
                                        showToast('Failed to create user');
                                    } else if (typeof alert === 'function') {
                                        alert('Failed to create user');
                                    }
                                });
                        });
                    }

                    if (searchInput) {
                        searchInput.addEventListener('input', renderUsers);
                    }
                    if (refreshBtn) {
                        refreshBtn.addEventListener('click', function () { loadUsers(); });
                    }

                    loadUsers();
                    loadDomains();
                })();
    </script>
</body>

</html>
{{ end }}
