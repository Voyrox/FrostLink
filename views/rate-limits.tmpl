{{ define "rate-limits" }}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="/img/logo.ico">
    <title>SparkProxy â€¢ Rate Limits</title>
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/sidebar.css" />
    <link rel="stylesheet" href="/css/rate-limits.css" />
</head>

<body class="page-rate-limits">
    <div class="app">
        {{ template "sidebar" . }}
        {{ template "notifications" . }}

        <main class="content" role="main" aria-labelledby="page-title">
            <header class="page-header">
                <h1 id="page-title">Rate Limits</h1>
                <p class="subtitle">Configure request rate limits for each domain</p>
            </header>

            <section class="panel" aria-label="Rate Limits Panel">
                <div class="toolbar">
                    <div class="left">
                        <label class="input-icon" aria-label="Search domains">
                            <span class="icon" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" />
                                    <path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                </svg>
                            </span>
                            <input type="search" placeholder="Search domains..." id="search-input" />
                        </label>
                    </div>
                    <div class="right">
                        <button class="btn ghost" type="button" id="refresh-btn">
                            <span class="icon orange" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="2" />
                                    <path d="M21 3v6h-6" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                </svg>
                            </span>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>

                <div class="table-wrap">
                    <table class="table" role="grid">
                        <thead>
                            <tr>
                                <th scope="col"><span class="th"><span class="icon" aria-hidden="true">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                                <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke="currentColor" stroke-width="2"/>
                                            </svg>
                                        </span> Domain</span></th>
                                <th scope="col"><span class="th"><span class="icon" aria-hidden="true">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </span> RPS</span></th>
                                <th scope="col"><span class="th"><span class="icon" aria-hidden="true">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                        </span> Burst</span></th>
                                <th scope="col"><span class="th"><span class="icon" aria-hidden="true">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path d="M18 20V10M12 20V4M6 20v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </span> Enabled</span></th>
                                <th scope="col" class="actions-col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        (function () {
            const tableBody = document.querySelector('.table tbody');
            const refreshBtn = document.getElementById('refresh-btn');
            const searchInput = document.getElementById('search-input');
            let allDomains = [];

            function escapeHtml(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            function renderTable(domains) {
                if (!tableBody) return;
                tableBody.innerHTML = '';
                if (!domains || domains.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="empty-state">No domains configured</td></tr>';
                    return;
                }
                domains.forEach(domain => {
                    const tr = document.createElement('tr');

                    const tdDomain = document.createElement('td');
                    const domainLink = document.createElement('a');
                    domainLink.href = '/domains/' + encodeURIComponent(domain.domain);
                    domainLink.className = 'domain-link';
                    domainLink.textContent = domain.domain || '';
                    domainLink.style.color = 'inherit';
                    domainLink.style.textDecoration = 'none';
                    tdDomain.appendChild(domainLink);

                    const tdRps = document.createElement('td');
                    const rpsInput = document.createElement('input');
                    rpsInput.type = 'number';
                    rpsInput.min = '0';
                    rpsInput.value = domain.requests_per_second || 10;
                    rpsInput.className = 'input rps-input';
                    rpsInput.style.width = '80px';
                    rpsInput.dataset.domain = domain.domain;
                    tdRps.appendChild(rpsInput);

                    const tdBurst = document.createElement('td');
                    const burstInput = document.createElement('input');
                    burstInput.type = 'number';
                    burstInput.min = '0';
                    burstInput.value = domain.burst || 0;
                    burstInput.className = 'input burst-input';
                    burstInput.style.width = '80px';
                    burstInput.dataset.domain = domain.domain;
                    tdBurst.appendChild(burstInput);

                    const tdEnabled = document.createElement('td');
                    const label = document.createElement('label');
                    label.className = 'switch';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = domain.enabled === true || domain.enabled === 'true';
                    checkbox.dataset.domain = domain.domain;
                    const slider = document.createElement('span');
                    slider.className = 'slider';
                    label.appendChild(checkbox);
                    label.appendChild(slider);
                    tdEnabled.appendChild(label);

                    const tdActions = document.createElement('td');
                    tdActions.className = 'actions';
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'btn small primary';
                    saveBtn.type = 'button';
                    saveBtn.textContent = 'Save';
                    saveBtn.addEventListener('click', function () {
                        saveRateLimit(domain.domain);
                    });
                    tdActions.appendChild(saveBtn);

                    tr.appendChild(tdDomain);
                    tr.appendChild(tdRps);
                    tr.appendChild(tdBurst);
                    tr.appendChild(tdEnabled);
                    tr.appendChild(tdActions);

                    tableBody.appendChild(tr);
                });
            }

            function loadRateLimits() {
                fetch('/api/rate-limits')
                    .then(r => r.ok ? r.json() : Promise.reject(r.status))
                    .then(data => {
                        allDomains = data && data.rate_limits ? data.rate_limits : [];
                        filterAndRender();
                    })
                    .catch(err => {
                        console.error('Failed to load rate limits', err);
                        if (typeof showToast === 'function') {
                            showToast('Failed to load rate limits');
                        }
                    });
            }

            function filterAndRender() {
                const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
                const filtered = allDomains.filter(d => {
                    if (!searchTerm) return true;
                    const domain = (d.domain || '').toLowerCase();
                    return domain.includes(searchTerm);
                });
                renderTable(filtered);
            }

            function saveRateLimit(domain) {
                const rpsInput = document.querySelector('.rps-input[data-domain="' + domain + '"]');
                const burstInput = document.querySelector('.burst-input[data-domain="' + domain + '"]');
                const checkbox = document.querySelector('.switch input[type="checkbox"][data-domain="' + domain + '"]');

                const rps = rpsInput ? parseInt(rpsInput.value, 10) || 0 : 0;
                const burst = burstInput ? parseInt(burstInput.value, 10) || 0 : 0;
                const enabled = checkbox ? checkbox.checked : false;

                fetch('/api/domains/' + encodeURIComponent(domain) + '/rate-limit', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requests_per_second: rps,
                        burst: burst,
                        enabled: enabled
                    })
                })
                    .then(r => r.ok ? r.json() : Promise.reject(r))
                    .then(data => {
                        if (data && data.error) {
                            throw new Error(data.error);
                        }
                        if (typeof showToast === 'function') {
                            showToast('Rate limit saved for ' + domain);
                        }
                    })
                    .catch(err => {
                        console.error('Failed to save rate limit', err);
                        if (typeof showToast === 'function') {
                            showToast('Failed to save rate limit for ' + domain);
                        }
                    });
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', function () {
                    loadRateLimits();
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', filterAndRender);
            }

            loadRateLimits();
        })();
    </script>
</body>

</html>
{{ end }}
