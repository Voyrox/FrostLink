{{ define "domains" }}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="/img/logo.ico">
    <title>SparkProxy â€¢ Domains</title>
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/sidebar.css" />
    <link rel="stylesheet" href="/css/domains.css" />
</head>

<body class="page-domains">
    <div class="app">
        {{ template "sidebar" . }}
        {{ template "notifications" . }}

        <main class="content" role="main" aria-labelledby="page-title">
            <header class="page-header">
                <h1 id="page-title">Manage Sites</h1>
                <p class="subtitle">Create and manage sites to enable connectivity to private networks</p>
            </header>

            <section class="panel" aria-label="Sites Panel">
                <div class="toolbar">
                    <div class="left">
                        <label class="input-icon" aria-label="Search sites">
                            <span class="icon" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" />
                                    <path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                </svg>
                            </span>
                            <input type="search" placeholder="Search sites..." />
                        </label>
                    </div>
                    <div class="right">
                        <button class="btn ghost" type="button" id="refresh-domains-btn">
                            <span class="icon orange" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="2" />
                                    <path d="M21 3v6h-6" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                </svg>
                            </span>
                            <span>Refresh</span>
                        </button>
                        <button class="btn ghost" type="button" id="open-domain-modal">
                            <span class="icon orange" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                </svg>
                            </span>
                            <span>Add site</span>
                        </button>
                    </div>
                </div>

                <div class="table-wrap">
                    <table class="table" role="grid">
                        <thead>
                            <tr>
                                <th scope="col"><span class="th"><span class="icon" aria-hidden="true">
                                            <svg width="16px" height="16px" viewBox="0 0 48 48"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <title>domain</title>
                                                <g id="Layer_2" data-name="Layer 2">
                                                    <g id="invisible_box" data-name="invisible box">
                                                        <rect width="48" height="48" fill="none" />
                                                    </g>
                                                    <g id="icons_Q2" data-name="icons Q2">
                                                        <path stroke="#ffffff"
                                                            d="M24,2A22,22,0,1,0,46,24,21.9,21.9,0,0,0,24,2ZM40.1,16H35.2a27.8,27.8,0,0,0-3-8A18.5,18.5,0,0,1,40.1,16ZM42,24a17.5,17.5,0,0,1-.5,4H35.8c.1-1.3.2-2.6.2-4s-.1-2.7-.2-4h5.7A17.5,17.5,0,0,1,42,24ZM6,24a17.5,17.5,0,0,1,.5-4h5.7c-.1,1.3-.2,2.6-.2,4s.1,2.7.2,4H6.5A17.5,17.5,0,0,1,6,24Zm10,0c0-1.4.1-2.7.2-4H22v8H16.2C16.1,26.7,16,25.4,16,24ZM26,6.7a11.7,11.7,0,0,1,3,3.7A21.7,21.7,0,0,1,31.1,16H26Zm-4,0V16H16.9A21.7,21.7,0,0,1,19,10.4,11.7,11.7,0,0,1,22,6.7ZM22,32v9.3a11.7,11.7,0,0,1-3-3.7A21.7,21.7,0,0,1,16.9,32Zm4,9.3V32h5.1A21.7,21.7,0,0,1,29,37.6,11.7,11.7,0,0,1,26,41.3ZM26,28V20h5.8c.1,1.3.2,2.6.2,4s-.1,2.7-.2,4ZM15.8,8a27.8,27.8,0,0,0-3,8H7.9A18.5,18.5,0,0,1,15.8,8ZM7.9,32h4.9a27.8,27.8,0,0,0,3,8A18.5,18.5,0,0,1,7.9,32Zm24.3,8a27.8,27.8,0,0,0,3-8h4.9A18.5,18.5,0,0,1,32.2,40Z" />
                                                    </g>
                                                </g>
                                            </svg>
                                        </span> Name</span></th>
                                <th scope="col"><span class="th"><span class="icon" aria-hidden="true">
                                            <svg width="16px" height="16px" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M3 12H21M12 8V12M6.5 12V16M17.5 12V16M10.1 8H13.9C14.4601 8 14.7401 8 14.954 7.89101C15.1422 7.79513 15.2951 7.64215 15.391 7.45399C15.5 7.24008 15.5 6.96005 15.5 6.4V4.6C15.5 4.03995 15.5 3.75992 15.391 3.54601C15.2951 3.35785 15.1422 3.20487 14.954 3.10899C14.7401 3 14.4601 3 13.9 3H10.1C9.53995 3 9.25992 3 9.04601 3.10899C8.85785 3.20487 8.70487 3.35785 8.60899 3.54601C8.5 3.75992 8.5 4.03995 8.5 4.6V6.4C8.5 6.96005 8.5 7.24008 8.60899 7.45399C8.70487 7.64215 8.85785 7.79513 9.04601 7.89101C9.25992 8 9.53995 8 10.1 8ZM15.6 21H19.4C19.9601 21 20.2401 21 20.454 20.891C20.6422 20.7951 20.7951 20.6422 20.891 20.454C21 20.2401 21 19.9601 21 19.4V17.6C21 17.0399 21 16.7599 20.891 16.546C20.7951 16.3578 20.6422 16.2049 20.454 16.109C20.2401 16 19.9601 16 19.4 16H15.6C15.0399 16 14.7599 16 14.546 16.109C14.3578 16.2049 14.2049 16.3578 14.109 16.546C14 16.7599 14 17.0399 14 17.6V19.4C14 19.9601 14 20.2401 14.109 20.454C14.2049 20.6422 14.3578 20.7951 14.546 20.891C14.7599 21 15.0399 21 15.6 21ZM4.6 21H8.4C8.96005 21 9.24008 21 9.45399 20.891C9.64215 20.7951 9.79513 20.6422 9.89101 20.454C10 20.2401 10 19.9601 10 19.4V17.6C10 17.0399 10 16.7599 9.89101 16.546C9.79513 16.3578 9.64215 16.2049 9.45399 16.109C9.24008 16 8.96005 16 8.4 16H4.6C4.03995 16 3.75992 16 3.54601 16.109C3.35785 16.2049 3.20487 16.3578 3.10899 16.546C3 16.7599 3 17.0399 3 17.6V19.4C3 19.9601 3 20.2401 3.10899 20.454C3.20487 20.6422 3.35785 20.7951 3.54601 20.891C3.75992 21 4.03995 21 4.6 21Z"
                                                    stroke="#ffffff" stroke-width="2" stroke-linecap="round"
                                                    stroke-linejoin="round" />
                                            </svg>
                                        </span> Online</span></th>
                                <th scope="col"><span class="th"><span class="icon" aria-hidden="true">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path d="M12 1.75L3.75 6v12L12 22.25 20.25 18V6L12 1.75zM12 11a1 1 0 011 1v4a1 1 0 01-2 0v-4a1 1 0 011-1zm0-4a1.25 1.25 0 100 2.5A1.25 1.25 0 0012 7z" stroke="#ffffff" stroke-width="1.5" fill="none"/>
                                            </svg>
                                        </span> Auth</span></th>
                                <th scope="col"><span class="th"><span class="icon" aria-hidden="true">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </span> Attack</span></th>
                                <th scope="col"><span class="th"><span class="icon" aria-hidden="true">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" />
                                            </svg>
                                        </span> Data in</span></th>
                                <th scope="col"><span class="th"><span class="icon" aria-hidden="true">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path d="M19 12H5m7-7l-7 7 7 7" stroke="currentColor" stroke-width="2"
                                                    stroke-linecap="round" />
                                            </svg>
                                        </span> Data out</span></th>
                                <th scope="col"><span class="th"><span class="icon" aria-hidden="true">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </span> SSL</span></th>
                                <th scope="col" class="actions-col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div class="pager">
                    <div class="page-info">Page 1 of 1</div>
                    <div class="page-controls">
                        <button class="btn small ghost" aria-label="First page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M18 6l-6 6 6 6" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                    <path d="M12 6l-6 6 6 6" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" aria-label="Previous page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" aria-label="Next page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" aria-label="Last page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M6 6l6 6-6 6" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                    <path d="M12 6l6 6-6 6" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal-backdrop" id="domain-modal" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="domain-modal-title">
            <div class="domain-form">
                <h2 id="domain-modal-title">Add site</h2>
                <div class="domain-info" id="domain-info"><div class="domain-details"><span class="domain-status none">Create a new site</span></div></div>
                <form id="domain-form">
                    <div class="field-row">
                        <label class="full-width">
                            <span>Domain</span>
                            <input type="text" name="domain" required placeholder="example.com">
                        </label>
                    </div>
                    <div class="field-row">
                        <label class="full-width">
                            <span>Target</span>
                            <input type="text" name="target" required placeholder="http://127.0.0.1:8080">
                        </label>
                    </div>
                    <div class="field-row">
                        <label class="inline-checkbox">
                            <input type="checkbox" name="allow_http" id="domain-allow-http" checked>
                            <span>Allow HTTP</span>
                        </label>
                        <label class="inline-checkbox">
                            <input type="checkbox" name="allow_ssl" id="domain-allow-ssl" checked>
                            <span>Allow SSL</span>
                        </label>
                    </div>
                    <div class="field-row">
                        <label class="full-width">
                            <span>Certificate</span>
                            <div class="radio-row">
                                <label>
                                    <input type="radio" name="cert_mode" value="generate" checked>
                                    <span>Generate automatically</span>
                                </label>
                                <label>
                                    <input type="radio" name="cert_mode" value="custom">
                                    <span>Custom paths</span>
                                </label>
                            </div>
                        </label>
                    </div>
                    <div class="field-row ssl-details" id="ssl-details" hidden>
                        <label class="full-width">
                            <span>Certificate path</span>
                            <input type="text" name="cert_path" placeholder="/etc/ssl/example.crt">
                        </label>
                        <label class="full-width">
                            <span>Key path</span>
                            <input type="text" name="key_path" placeholder="/etc/ssl/example.key">
                        </label>
                    </div>
                    <div class="actions-row">
                        <button class="btn primary" type="submit">Create site</button>
                        <button class="btn ghost" type="button" id="domain-cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="edit-domain-modal" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-domain-modal-title">
            <div class="domain-form">
                <h2 id="edit-domain-modal-title">Edit site</h2>
                <div class="domain-info" id="edit-domain-info"><div class="domain-details"><span class="domain-status none">Edit site configuration</span></div></div>
                <form id="edit-domain-form">
                    <input type="hidden" name="edit_domain" id="edit-domain-name">
                    <div class="field-row">
                        <label class="full-width">
                            <span>Domain</span>
                            <input type="text" id="edit-domain" disabled placeholder="example.com">
                        </label>
                    </div>
                    <div class="field-row">
                        <label class="full-width">
                            <span>Target</span>
                            <input type="text" name="target" id="edit-target" required placeholder="http://127.0.0.1:8080">
                        </label>
                    </div>
                    <div class="field-row">
                        <label class="inline-checkbox">
                            <input type="checkbox" name="allow_http" id="edit-allow-http">
                            <span>Allow HTTP</span>
                        </label>
                        <label class="inline-checkbox">
                            <input type="checkbox" name="allow_ssl" id="edit-allow-ssl">
                            <span>Allow SSL</span>
                        </label>
                    </div>
                    <div class="field-row">
                        <label class="full-width">
                            <span>Certificate</span>
                            <div class="radio-row">
                                <label>
                                    <input type="radio" name="edit_cert_mode" value="generate" id="edit-cert-generate">
                                    <span>Generate automatically</span>
                                </label>
                                <label>
                                    <input type="radio" name="edit_cert_mode" value="custom" id="edit-cert-custom">
                                    <span>Custom paths</span>
                                </label>
                            </div>
                        </label>
                    </div>
                    <div class="field-row ssl-details" id="edit-ssl-details" hidden>
                        <label class="full-width">
                            <span>Certificate path</span>
                            <input type="text" name="cert_path" id="edit-cert-path" placeholder="/etc/ssl/example.crt">
                        </label>
                        <label class="full-width">
                            <span>Key path</span>
                            <input type="text" name="key_path" id="edit-key-path" placeholder="/etc/ssl/example.key">
                        </label>
                    </div>
                    <div class="actions-row">
                        <button class="btn primary" type="submit">Save changes</button>
                        <button class="btn ghost" type="button" id="edit-domain-cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="cert-modal" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="cert-modal-title">
            <div class="cert-form">
                <h2 id="cert-modal-title">SSL Certificate</h2>
                <form id="cert-form">
                    <input type="hidden" name="cert_domain" id="cert-domain-name" />
                    <div class="cert-info" id="cert-info"></div>
                    <div class="field-row">
                        <label class="full-width">
                            <span>Domain</span>
                            <select name="domain" id="cert-domain-select" required></select>
                        </label>
                    </div>
                    <div class="field-row">
                        <label class="full-width">
                            <span>DNS Provider</span>
                            <select name="dns_provider" id="cert-dns-provider" required>
                                <option value="cloudflare">Cloudflare</option>
                            </select>
                        </label>
                    </div>
                    <div class="field-row">
                        <label class="full-width">
                            <span>API Token (optional)</span>
                            <input type="password" name="api_token" id="cert-api-token" placeholder="Uses CLOUDFLARE_API_TOKEN env if empty" />
                        </label>
                    </div>
                    <div class="field-row">
                        <label class="inline-checkbox">
                            <input type="checkbox" name="staging" id="cert-staging" checked />
                            <span>Use staging server (recommended for testing)</span>
                        </label>
                    </div>
                    <div class="actions-row">
                        <button class="btn primary" type="submit" id="cert-request-btn">Request Certificate</button>
                        <button class="btn" type="button" id="cert-renew-btn" hidden>Renew</button>
                        <button class="btn danger" type="button" id="cert-revoke-btn" hidden>Revoke</button>
                        <button class="btn ghost" type="button" id="cert-cancel-btn">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const card = document.querySelector('.profile-card');
            if (!card) return;
            const img = card.querySelector('.avatar');
            const fallback = card.querySelector('.avatar-fallback');
            const nameEl = card.querySelector('.username');
            const initial = (nameEl && nameEl.textContent || '').trim().charAt(0).toUpperCase() || '?';
            if (fallback) { fallback.textContent = initial; }
            function showFallback() { if (img) { img.style.display = 'none'; } if (fallback) { fallback.style.display = 'grid'; } }
            if (!img || !img.getAttribute('src')) { showFallback(); }
            else { img.addEventListener('error', showFallback); }
        })();

        (function () {
            const tableBody = document.querySelector('.table tbody');
            if (!tableBody) return;

            function formatBytes(bytes) {
                if (!bytes || bytes <= 0) return '0 B';
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let i = 0;
                let value = bytes;
                while (value >= 1024 && i < units.length - 1) {
                    value /= 1024;
                    i++;
                }
                return value.toFixed(1) + ' ' + units[i];
            }

            function render() {
                fetch('/api/proxys')
                    .then(r => r.ok ? r.json() : Promise.reject(r.status))
                    .then(data => {
                        const configs = (data && data.configs) || [];
                        tableBody.innerHTML = '';
                        configs.forEach(cfg => {
                            const tr = document.createElement('tr');

                            const tdName = document.createElement('td');
                            const domainLink = document.createElement('a');
                            domainLink.href = '/domains/' + encodeURIComponent(cfg.domain);
                            domainLink.className = 'domain-link';
                            domainLink.textContent = cfg.domain || cfg.host || '';
                            domainLink.style.color = 'inherit';
                            domainLink.style.textDecoration = 'none';
                            tdName.appendChild(domainLink);

                            const tdOnline = document.createElement('td');
                            const statusSpan = document.createElement('span');
                            const hasHealth = Object.prototype.hasOwnProperty.call(cfg, 'online');
                            const isOnline = hasHealth ? !!cfg.online : (!!cfg.HTTP || !!cfg.SSL);
                            statusSpan.className = 'status' + (isOnline ? ' online' : '');
                            tdOnline.appendChild(statusSpan);
                            tdOnline.appendChild(document.createTextNode(' ' + (isOnline ? 'Online' : 'Offline')));

                            const tdAuth = document.createElement('td');
                            const authToggle = document.createElement('button');
                            const authOn = !!cfg.require_auth;
                            authToggle.type = 'button';
                            authToggle.className = 'auth-toggle' + (authOn ? ' enabled' : ' disabled');
                            authToggle.setAttribute('aria-pressed', String(authOn));
                            authToggle.textContent = authOn ? 'On' : 'Off';
                            authToggle.addEventListener('click', function () {
                                const next = !authOn;
                                fetch('/api/domains/' + encodeURIComponent(cfg.domain) + '/auth', {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ require_auth: next })
                                })
                                    .then(function (r) { return r.ok ? r.json() : Promise.reject(r); })
                                    .then(function () { render(); })
                                    .catch(function (err) {
                                        console.error('Failed to update auth for domain', cfg.domain, err);
                                        if (typeof showToast === 'function') {
                                            showToast('Failed to update auth for ' + (cfg.domain || 'domain'));
                                        }
                                    });
                            });
                            tdAuth.appendChild(authToggle);

                            const tdAttack = document.createElement('td');
                            const attackToggle = document.createElement('button');
                            const attackOn = !!cfg.under_attack_enabled;
                            attackToggle.type = 'button';
                            attackToggle.className = 'attack-toggle' + (attackOn ? ' enabled' : ' disabled');
                            attackToggle.setAttribute('aria-pressed', String(attackOn));
                            attackToggle.textContent = attackOn ? 'On' : 'Off';
                            attackToggle.addEventListener('click', function () {
                                const next = !attackOn;
                                fetch('/api/domains/' + encodeURIComponent(cfg.domain) + '/under-attack', {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ enabled: next })
                                })
                                    .then(function (r) { return r.ok ? r.json() : Promise.reject(r); })
                                    .then(function () { render(); })
                                    .catch(function (err) {
                                        console.error('Failed to update under-attack for domain', cfg.domain, err);
                                        if (typeof showToast === 'function') {
                                            showToast('Failed to update under-attack for ' + (cfg.domain || 'domain'));
                                        }
                                    });
                            });
                            tdAttack.appendChild(attackToggle);

                            const tdIn = document.createElement('td');
                            tdIn.textContent = formatBytes(cfg.data_in_total || 0);

                            const tdOut = document.createElement('td');
                            tdOut.textContent = formatBytes(cfg.data_out_total || 0);

                            const tdSsl = document.createElement('td');
                            const isSslEnabled = cfg.SSL === true || cfg.SSL === "true";

                            const sslBadge = document.createElement('span');
                            sslBadge.className = 'ssl-badge ssl-none';
                            sslBadge.textContent = 'None';
                            tdSsl.appendChild(sslBadge);

                            const sslScanBtn = document.createElement('button');
                            sslScanBtn.className = 'btn small ghost ssl-scan-btn';
                            sslScanBtn.type = 'button';
                            sslScanBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-2.64-6.36"/><path d="M21 3v6h-6"/></svg>';
                            sslScanBtn.title = 'Scan for certificate';
                            tdSsl.appendChild(sslScanBtn);

                            const sslBtn = document.createElement('button');
                            sslBtn.className = 'btn small ghost ssl-lock-btn';
                            sslBtn.type = 'button';
                            sslBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>';
                            sslBtn.title = 'Manage SSL certificate';
                            sslBtn.addEventListener('click', function() {
                                openCertModal(cfg.domain);
                            });
                            tdSsl.appendChild(sslBtn);

                            if (isSslEnabled) {
                                fetch('/api/certs/' + encodeURIComponent(cfg.domain) + '/verify')
                                    .then(r => r.ok ? r.json() : null)
                                    .then(data => {
                                        if (!data) return;
                                        let status = 'None';
                                        let cssClass = 'none';
                                        let tooltip = '';

                                        if (data.custom_cert_configured && data.custom_cert_valid) {
                                            status = 'Custom';
                                            cssClass = 'custom';
                                        } else if (data.custom_cert_configured && !data.custom_cert_valid) {
                                            status = 'Invalid';
                                            cssClass = 'invalid';
                                            tooltip = data.custom_cert_error || 'Custom cert invalid';
                                        } else if (data.auto_detected && data.auto_detected_valid) {
                                            status = 'Detected';
                                            cssClass = 'detected';
                                            if (data.auto_detected_path) {
                                                tooltip = data.auto_detected_path;
                                            }
                                        } else if (data.acme_exists) {
                                            status = 'Auto';
                                            cssClass = 'auto';
                                        }

                                        if (data.effective_cert_info && data.effective_cert_info.expires_at) {
                                            const expDate = new Date(data.effective_cert_info.expires_at);
                                            const daysLeft = Math.max(0, Math.ceil((expDate - new Date()) / (1000 * 60 * 60 * 24)));
                                            if (daysLeft <= 7) {
                                                cssClass = 'expired';
                                            } else if (daysLeft <= 30) {
                                                cssClass = 'expiring';
                                            }
                                        }

                                        sslBadge.className = 'ssl-badge ssl-' + cssClass;
                                        sslBadge.textContent = status;
                                        if (tooltip) {
                                            sslBadge.title = tooltip;
                                        }
                                    })
                                    .catch(() => {});
                            }

                            sslScanBtn.addEventListener('click', function() {
                                sslScanBtn.disabled = true;
                                sslScanBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin"><path d="M21 12a9 9 0 1 1-2.64-6.36"/><path d="M21 3v6h-6"/></svg>';
                                fetch('/api/certs/' + encodeURIComponent(cfg.domain) + '/verify')
                                    .then(r => r.ok ? r.json() : Promise.reject(r))
                                    .then(data => {
                                        showToast('Certificate scan complete');
                                        render();
                                    })
                                    .catch(err => {
                                        console.error('Scan failed', err);
                                        showToast('Scan failed');
                                        render();
                                    });
                            });

                            const tdActions = document.createElement('td');
                            tdActions.className = 'actions';
                            const editBtn = document.createElement('button');
                            editBtn.className = 'btn small ghost';
                            editBtn.type = 'button';
                            editBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
                            editBtn.title = 'Edit';
                            editBtn.addEventListener('click', function() {
                                openEditDomainModal(cfg);
                            });
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'btn small ghost danger';
                            deleteBtn.type = 'button';
                            deleteBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
                            deleteBtn.title = 'Delete';
                            deleteBtn.addEventListener('click', function() {
                                if (confirm('Delete domain "' + cfg.domain + '"? This cannot be undone.')) {
                                    fetch('/api/domains/' + encodeURIComponent(cfg.domain), { method: 'DELETE' })
                                        .then(function(r) { return r.ok ? r.json() : Promise.reject(r); })
                                        .then(function() {
                                            showToast('Domain deleted');
                                            render();
                                        })
                                        .catch(function(err) {
                                            console.error('Failed to delete domain', err);
                                            showToast('Failed to delete domain');
                                        });
                                }
                            });
                            tdActions.appendChild(editBtn);
                            tdActions.appendChild(deleteBtn);

                            tr.appendChild(tdName);
                            tr.appendChild(tdOnline);
                            tr.appendChild(tdAuth);
                            tr.appendChild(tdAttack);
                            tr.appendChild(tdIn);
                            tr.appendChild(tdOut);
                            tr.appendChild(tdSsl);
                            tr.appendChild(tdActions);

                            tableBody.appendChild(tr);
                        });
                    })
                    .catch(err => {
                        console.error('Failed to load /api/proxys', err);
                        if (typeof showToast === 'function') {
                            showToast('Failed to load domains');
                        }
                    });
            }

            render();

            const refreshBtn = document.getElementById('refresh-domains-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function () {
                    render();
                });
            }

            const domainModal = document.getElementById('domain-modal');
            const domainForm = document.getElementById('domain-form');
            const openDomainBtn = document.getElementById('open-domain-modal');
            const domainCancelBtn = document.getElementById('domain-cancel-btn');
            const sslDetails = document.getElementById('ssl-details');
            const allowHttpCheckbox = document.getElementById('domain-allow-http');
            const allowSslCheckbox = document.getElementById('domain-allow-ssl');
            const certModeRadios = document.querySelectorAll('input[name="cert_mode"]');

            function updateSslDetailsVisibility() {
                let mode = 'generate';
                certModeRadios.forEach(function (r) {
                    if (r.checked) {
                        mode = r.value;
                    }
                });
                if (sslDetails) {
                    sslDetails.hidden = mode !== 'custom';
                }
            }

            function openDomainModal() {
                if (!domainModal) return;
                domainModal.hidden = false;
            }

            function closeDomainModal() {
                if (!domainModal) return;
                domainModal.hidden = true;
                if (domainForm) {
                    domainForm.reset();
                }
                if (allowHttpCheckbox) allowHttpCheckbox.checked = true;
                if (allowSslCheckbox) allowSslCheckbox.checked = true;
                updateSslDetailsVisibility();
            }

            certModeRadios.forEach(function (r) {
                r.addEventListener('change', updateSslDetailsVisibility);
            });
            updateSslDetailsVisibility();

            if (openDomainBtn) {
                openDomainBtn.addEventListener('click', function () {
                    openDomainModal();
                });
            }

            if (domainCancelBtn) {
                domainCancelBtn.addEventListener('click', function () {
                    closeDomainModal();
                });
            }

            if (domainModal) {
                domainModal.addEventListener('click', function (e) {
                    if (e.target === domainModal) {
                        closeDomainModal();
                    }
                });
            }

            if (domainForm) {
                domainForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(domainForm);
                    const domain = String(formData.get('domain') || '').trim();
                    const target = String(formData.get('target') || '').trim();
                    const allowHTTP = !!formData.get('allow_http');
                    const allowSSL = !!formData.get('allow_ssl');
                    let certMode = String(formData.get('cert_mode') || 'generate').toLowerCase();
                    const certPath = String(formData.get('cert_path') || '').trim();
                    const keyPath = String(formData.get('key_path') || '').trim();

                    if (!domain || !target) {
                        if (typeof showToast === 'function') {
                            showToast('Domain and target are required');
                        } else if (typeof alert === 'function') {
                            alert('Domain and target are required');
                        }
                        return;
                    }

                    let httpVal = allowHTTP;
                    let sslVal = allowSSL;
                    if (!httpVal && !sslVal) {
                        httpVal = true;
                    }

                    if (sslVal && certMode === 'custom' && (!certPath || !keyPath)) {
                        if (typeof showToast === 'function') {
                            showToast('Certificate and key paths are required for custom SSL');
                        } else if (typeof alert === 'function') {
                            alert('Certificate and key paths are required for custom SSL');
                        }
                        return;
                    }

                    fetch('/api/domains', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            domain: domain,
                            target: target,
                            ssl: sslVal,
                            http: httpVal,
                            cert_mode: certMode,
                            cert_path: certPath,
                            key_path: keyPath
                        })
                    })
                        .then(function (r) {
                            var ct = r.headers.get('content-type') || '';
                            if (!ct.includes('application/json')) {
                                return r.text().then(function () {
                                    var msg = 'Unexpected response from server';
                                    if (typeof showToast === 'function') {
                                        showToast(msg);
                                    } else if (typeof alert === 'function') {
                                        alert(msg);
                                    }
                                    throw new Error(msg);
                                });
                            }
                            return r.json().then(function (data) {
                                if (!r.ok || (data && data.error)) {
                                    var msg2 = (data && data.error) || 'Failed to create site';
                                    if (typeof showToast === 'function') {
                                        showToast(msg2);
                                    } else if (typeof alert === 'function') {
                                        alert(msg2);
                                    }
                                    throw new Error(msg2);
                                }
                                return data;
                            });
                        })
                        .then(function () {
                            closeDomainModal();
                            if (typeof showToast === 'function') {
                                showToast('Site created successfully');
                            }
                            render();
                        })
                        .catch(function (err) {
                            console.error('Failed to create site', err);
                            if (typeof showToast === 'function') {
                                showToast('Failed to create site');
                            } else if (typeof alert === 'function') {
                                alert('Failed to create site');
                            }
                        });
                });
            }
            const editDomainModal = document.getElementById('edit-domain-modal');
            const editDomainForm = document.getElementById('edit-domain-form');
            const editDomainCancelBtn = document.getElementById('edit-domain-cancel-btn');
            const editCertModeRadios = document.querySelectorAll('input[name="edit_cert_mode"]');
            const editSslDetails = document.getElementById('edit-ssl-details');

            function updateEditSslDetailsVisibility() {
                let mode = 'custom';
                editCertModeRadios.forEach(function (r) {
                    if (r.checked) {
                        mode = r.value;
                    }
                });
                if (editSslDetails) {
                    editSslDetails.hidden = mode !== 'custom';
                }
            }

            editCertModeRadios.forEach(function (r) {
                r.addEventListener('change', updateEditSslDetailsVisibility);
            });

            function openEditDomainModal(cfg) {
                if (!editDomainModal) return;
                document.getElementById('edit-domain-name').value = cfg.domain;
                document.getElementById('edit-domain').value = cfg.domain;
                document.getElementById('edit-target').value = cfg.host || '';
                document.getElementById('edit-allow-http').checked = cfg.HTTP !== false;
                document.getElementById('edit-allow-ssl').checked = cfg.SSL === true;
                document.getElementById('edit-cert-path').value = cfg.pubkey || '';
                document.getElementById('edit-key-path').value = cfg.privkey || '';

                const generateRadio = document.getElementById('edit-cert-generate');
                const customRadio = document.getElementById('edit-cert-custom');
                if (cfg.auto_cert) {
                    if (generateRadio) generateRadio.checked = true;
                    if (customRadio) customRadio.checked = false;
                } else {
                    if (customRadio) customRadio.checked = true;
                    if (generateRadio) generateRadio.checked = false;
                }
                updateEditSslDetailsVisibility();

                editDomainModal.hidden = false;
            }

            function closeEditDomainModal() {
                if (!editDomainModal) return;
                editDomainModal.hidden = true;
                if (editDomainForm) {
                    editDomainForm.reset();
                }
            }

            if (editDomainCancelBtn) {
                editDomainCancelBtn.addEventListener('click', function () {
                    closeEditDomainModal();
                });
            }

            if (editDomainModal) {
                editDomainModal.addEventListener('click', function (e) {
                    if (e.target === editDomainModal) {
                        closeEditDomainModal();
                    }
                });
            }

            if (editDomainForm) {
                editDomainForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(editDomainForm);
                    const domain = String(formData.get('edit_domain') || '').trim();
                    const target = String(formData.get('target') || '').trim();
                    const allowHTTP = !!formData.get('allow_http');
                    const allowSSL = !!formData.get('allow_ssl');
                    const certPath = String(formData.get('cert_path') || '').trim();
                    const keyPath = String(formData.get('key_path') || '').trim();
                    const certMode = String(formData.get('edit_cert_mode') || 'generate').toLowerCase();

                    if (!domain || !target) {
                        showToast('Domain and target are required');
                        return;
                    }

                    fetch('/api/domains/' + encodeURIComponent(domain), {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            target: target,
                            http: allowHTTP,
                            ssl: allowSSL,
                            cert_mode: certMode,
                            cert_path: certMode === 'custom' ? certPath : '',
                            key_path: certMode === 'custom' ? keyPath : ''
                        })
                    })
                        .then(function (r) {
                            return r.json().then(function (data) {
                                if (!r.ok || (data && data.error)) {
                                    throw new Error((data && data.error) || 'Failed to update site');
                                }
                                return data;
                            });
                        })
                        .then(function () {
                            closeEditDomainModal();
                            showToast('Site updated successfully');
                            render();
                        })
                        .catch(function (err) {
                            console.error('Failed to update site', err);
                            showToast('Failed to update site');
                        });
                });
            }
            const certModal = document.getElementById('cert-modal');
            const certForm = document.getElementById('cert-form');
            const certCancelBtn = document.getElementById('cert-cancel-btn');
            const certDomainSelect = document.getElementById('cert-domain-select');
            const certDomainName = document.getElementById('cert-domain-name');
            const certInfo = document.getElementById('cert-info');
            const certRequestBtn = document.getElementById('cert-request-btn');
            const certRenewBtn = document.getElementById('cert-renew-btn');
            const certRevokeBtn = document.getElementById('cert-revoke-btn');

            function closeCertModal() {
                if (!certModal) return;
                certModal.hidden = true;
                if (certForm) {
                    certForm.reset();
                }
                certRequestBtn.hidden = false;
                certRenewBtn.hidden = true;
                certRevokeBtn.hidden = true;
            }

            function loadCertInfo(domain) {
                fetch('/api/certs')
                    .then(r => r.ok ? r.json() : Promise.reject(r))
                    .then(data => {
                        const certs = (data && data.certificates) || [];
                        const cert = certs.find(c => c.domain === domain);
                        if (cert) {
                            const expDate = cert.expires_at ? new Date(cert.expires_at) : null;
                            const daysLeft = expDate ? Math.max(0, Math.ceil((expDate - new Date()) / (1000 * 60 * 60 * 24))) : null;
                            const sourceLabel = cert.source === 'auto' ? 'Auto' : (cert.source === 'custom' ? 'Custom' : 'Unknown');
                            let statusClass = cert.source === 'auto' ? 'auto' : (cert.source === 'custom' ? 'custom' : 'none');
                            let expiryText = '';
                            if (daysLeft !== null) {
                                if (daysLeft <= 7) {
                                    statusClass = 'expired';
                                } else if (daysLeft <= 30) {
                                    statusClass = 'expiring';
                                }
                                const expStr = expDate ? expDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
                                expiryText = '<span class="cert-expiry">Expires <span class="days">' + daysLeft + '</span> days' + (expStr ? ' on ' + expStr : '') + '</span>';
                            }
                            certInfo.innerHTML = '<div class="cert-details"><span class="cert-status ' + statusClass + '">' + sourceLabel + '</span>' + expiryText + '</div>';
                            certRequestBtn.hidden = true;
                            certRenewBtn.hidden = false;
                            certRevokeBtn.hidden = false;
                        } else {
                            certInfo.innerHTML = '<div class="cert-details"><span class="cert-status none">No certificate</span></div>';
                            certRequestBtn.hidden = false;
                            certRenewBtn.hidden = true;
                            certRevokeBtn.hidden = true;
                        }
                    })
                    .catch(() => {
                        certInfo.innerHTML = '<div class="cert-details"><span class="cert-status none">Unable to load</span></div>';
                        certRequestBtn.hidden = false;
                        certRenewBtn.hidden = true;
                        certRevokeBtn.hidden = true;
                    });
            }

            function openCertModal(domain) {
                if (!certModal) return;
                certDomainName.value = domain;
                certDomainSelect.innerHTML = '';
                fetch('/api/proxys')
                    .then(r => r.ok ? r.json() : Promise.reject(r))
                    .then(data => {
                        const configs = (data && data.configs) || [];
                        configs.forEach(cfg => {
                            const opt = document.createElement('option');
                            opt.value = cfg.domain;
                            opt.textContent = cfg.domain;
                            if (cfg.domain === domain) {
                                opt.selected = true;
                            }
                            certDomainSelect.appendChild(opt);
                        });
                        loadCertInfo(domain);
                        certModal.hidden = false;
                    })
                    .catch(err => {
                        console.error('Failed to load domains for cert modal', err);
                        showToast('Failed to load domains');
                    });
            }

            if (certCancelBtn) {
                certCancelBtn.addEventListener('click', closeCertModal);
            }

            if (certModal) {
                certModal.addEventListener('click', function(e) {
                    if (e.target === certModal) {
                        closeCertModal();
                    }
                });
            }

            if (certDomainSelect) {
                certDomainSelect.addEventListener('change', function() {
                    certDomainName.value = this.value;
                    loadCertInfo(this.value);
                });
            }

            if (certForm) {
                certForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const domain = String(certDomainName.value || '').trim();
                    const dnsProvider = String(document.getElementById('cert-dns-provider').value || '');
                    const apiToken = String(document.getElementById('cert-api-token').value || '').trim();
                    const staging = !!document.getElementById('cert-staging').checked;

                    if (!domain) {
                        showToast('Domain is required');
                        return;
                    }

                    certRequestBtn.disabled = true;
                    certRequestBtn.textContent = 'Requesting...';

                    fetch('/api/certs/request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            domain: domain,
                            dns_provider: dnsProvider,
                            api_token: apiToken || undefined,
                            staging: staging
                        })
                    })
                        .then(function(r) {
                            return r.json().then(function(data) {
                                if (!r.ok || (data && data.error)) {
                                    throw new Error((data && data.error) || 'Failed to request certificate');
                                }
                                return data;
                            });
                        })
                        .then(function() {
                            closeCertModal();
                            showToast('Certificate requested successfully');
                            render();
                        })
                        .catch(function(err) {
                            console.error('Failed to request certificate', err);
                            showToast('Failed to request certificate: ' + (err.message || 'Unknown error'));
                        })
                        .finally(function() {
                            certRequestBtn.disabled = false;
                            certRequestBtn.textContent = 'Request Certificate';
                        });
                });
            }

            if (certRenewBtn) {
                certRenewBtn.addEventListener('click', function() {
                    const domain = certDomainName.value;
                    if (!domain) return;
                    if (!confirm('Renew certificate for ' + domain + '?')) return;

                    certRenewBtn.disabled = true;
                    certRenewBtn.textContent = 'Renewing...';

                    fetch('/api/certs/' + encodeURIComponent(domain) + '/renew', {
                        method: 'POST'
                    })
                        .then(function(r) {
                            return r.json().then(function(data) {
                                if (!r.ok || (data && data.error)) {
                                    throw new Error((data && data.error) || 'Failed to renew certificate');
                                }
                                return data;
                            });
                        })
                        .then(function() {
                            closeCertModal();
                            showToast('Certificate renewed successfully');
                            render();
                        })
                        .catch(function(err) {
                            console.error('Failed to renew certificate', err);
                            showToast('Failed to renew certificate: ' + (err.message || 'Unknown error'));
                        })
                        .finally(function() {
                            certRenewBtn.disabled = false;
                            certRenewBtn.textContent = 'Renew';
                        });
                });
            }

            if (certRevokeBtn) {
                certRevokeBtn.addEventListener('click', function() {
                    const domain = certDomainName.value;
                    if (!domain) return;
                    if (!confirm('Revoke certificate for ' + domain + '? This cannot be undone.')) return;

                    certRevokeBtn.disabled = true;
                    certRevokeBtn.textContent = 'Revoking...';

                    fetch('/api/certs/' + encodeURIComponent(domain), {
                        method: 'DELETE'
                    })
                        .then(function(r) {
                            return r.json().then(function(data) {
                                if (!r.ok || (data && data.error)) {
                                    throw new Error((data && data.error) || 'Failed to revoke certificate');
                                }
                                return data;
                            });
                        })
                        .then(function() {
                            closeCertModal();
                            showToast('Certificate revoked successfully');
                            render();
                        })
                        .catch(function(err) {
                            console.error('Failed to revoke certificate', err);
                            showToast('Failed to revoke certificate: ' + (err.message || 'Unknown error'));
                        })
                        .finally(function() {
                            certRevokeBtn.disabled = false;
                            certRevokeBtn.textContent = 'Revoke';
                        });
                });
            }
        })();
    </script>
    <style>
        .domain-form h2 {
            color: var(--orange);
        }
        .domain-info {
            margin-bottom: 1.25rem;
            padding: 0.75rem 1rem;
            background: rgba(252, 128, 51, 0.08);
            border-radius: 8px;
            border: 1px solid rgba(252, 128, 51, 0.15);
        }
        .domain-details {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .domain-status {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .domain-status.none {
            color: var(--muted);
        }
        .domain-status.active {
            color: #22c55e;
        }
        .ssl-details label.full-width {
            margin-top: 0;
        }
    </style>
</body>

</html>
{{ end }}