{{ define "login" }}
<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" type="image/x-icon" href="/img/logo.ico">
        <title>SparkProxy • Authentication</title>
        <link rel="stylesheet" href="/css/global.css" />
        <link rel="stylesheet" href="/css/login.css" />
    </head>
    <body>
     {{ template "notifications" . }}
        <div class="page">
            <div class="powered">Powered by <strong>SparkProxy</strong></div>

            <main class="card" role="main" aria-labelledby="auth-title">
                <h1 id="auth-title">Log into SparkProxy</h1>

                <div class="oauth-providers" id="oauth-providers">
                </div>

                <form id="panel-user" class="panel is-active" autocomplete="on" novalidate method="post" action="/login">
                    <label for="email">Email</label>
                    <input id="email" name="email" type="email" inputmode="email" autocomplete="email" placeholder="name@example.com" required>

                    <label for="password">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" placeholder="••••••••" required>

                    <div class="row between">
                        <a class="link" href="#" aria-label="Forgot your password?">Forgot your password?</a>
                    </div>

                    <button type="submit" class="btn primary">Log in</button>
                    <button type="button" class="btn ghost" id="btn-passkey">Continue with security key</button>
                </form>

                <div id="panel-passkey" class="panel" hidden>
                    <div class="fingerprint-container">
                        <div class="fingerprint-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4"/>
                                <path d="M14 13.12c0 2.38 0 6.38-1 8.88"/>
                                <path d="M17.29 21.02c.12-.6.43-2.3.5-3.02"/>
                                <path d="M2 12a10 10 0 0 1 18-6"/>
                                <path d="M2 16h.01"/>
                                <path d="M21.8 16c.2-2 .131-5.354 0-6"/>
                                <path d="M5 19.5C5.5 18 6 15 6 12a6 6 0 0 1 .34-2"/>
                                <path d="M8.65 22c.21-.66.45-1.32.57-2"/>
                                <path d="M9 6.8a6 6 0 0 1 9 5.2v2"/>
                            </svg>
                        </div>
                        <p>Use your fingerprint, face, or security key to continue</p>
                    </div>
                    <form id="passkey-form">
                        <label for="passkey-username">Username</label>
                        <input id="passkey-username" type="text" placeholder="Enter your username" required>
                        <button class="btn primary" type="submit">Authenticate with Passkey</button>
                    </form>
                    <button type="button" class="btn ghost back-btn" id="btn-back-user">Back to password</button>
                </div>
            </main>
        </div>

        <script>
            (function () {
                const panels = {
                    user: document.getElementById('panel-user'),
                    passkey: document.getElementById('panel-passkey'),
                };

                function showPanel(name) {
                    Object.entries(panels).forEach(([key, el]) => {
                        const show = key === name;
                        el.hidden = !show;
                        el.classList.toggle('is-active', show);
                    });
                }

                const passkeyBtn = document.getElementById('btn-passkey');
                if (passkeyBtn) {
                    passkeyBtn.addEventListener('click', () => showPanel('passkey'));
                }

                const backBtn = document.getElementById('btn-back-user');
                if (backBtn) {
                    backBtn.addEventListener('click', () => showPanel('user'));
                }

                const passkeyForm = document.getElementById('passkey-form');
                const passkeyUsernameInput = document.getElementById('passkey-username');

                if (passkeyForm) {
                    passkeyForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        const username = passkeyUsernameInput.value.trim();
                        if (!username) {
                            alert('Please enter your username');
                            return;
                        }

                        try {
                            const resp = await fetch('/api/passkeys/auth/start', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ username: username })
                            });
                            const data = await resp.json();
                            if (!resp.ok) {
                                throw new Error(data.error || 'Failed to start passkey authentication');
                            }

                            if (!navigator.credentials || !navigator.credentials.get) {
                                throw new Error('WebAuthn is not supported in this browser');
                            }

                            const challenge = base64ToArrayBuffer(data.response.challenge);
                            const allowCredentials = (data.response.allowCredentials || []).map(cred => ({
                                id: base64ToArrayBuffer(cred.id),
                                type: 'public-key',
                                transports: ['internal', 'hybrid']
                            }));

                            const publicKey = {
                                challenge: challenge,
                                rpId: data.response.rpId,
                                allowCredentials: allowCredentials,
                                timeout: data.response.timeout || 60000
                            };

                            const assertion = await navigator.credentials.get({ publicKey });
                            
                            const authData = assertion.response.authenticatorData;
                            const signature = assertion.response.signature;

                            const completeResp = await fetch('/api/passkeys/auth/complete', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    username: username,
                                    authenticator_data: arrayBufferToBase64URL(authData),
                                    signature: arrayBufferToBase64URL(signature),
                                    challenge: data.session_challenge
                                })
                            });
                            const completeData = await completeResp.json();
                            
                            if (!completeResp.ok) {
                                throw new Error(completeData.error || 'Passkey authentication failed');
                            }

                            window.location.href = '/dashboard';
                        } catch (err) {
                            alert('Passkey authentication failed: ' + err.message);
                            console.error(err);
                        }
                    });
                }

                function base64ToArrayBuffer(base64) {
                    let base64Standard = base64
                        .replace(/-/g, '+')
                        .replace(/_/g, '/');
                    while (base64Standard.length % 4 !== 0) {
                        base64Standard += '=';
                    }
                    const binary = atob(base64Standard);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) {
                        bytes[i] = binary.charCodeAt(i);
                    }
                    return bytes.buffer;
                }

                function arrayBufferToBase64URL(buffer) {
                    const bytes = new Uint8Array(buffer);
                    let binary = '';
                    for (let i = 0; i < bytes.length; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    const base64 = btoa(binary);
                    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
                }

                function loadOAuthProviders() {
                    const container = document.getElementById('oauth-providers');
                    if (!container) return;

                    fetch('/api/identity-providers/public')
                        .then(r => {
                            if (!r.ok) return { providers: [] };
                            return r.json();
                        })
                        .then(data => {
                            const providers = (data && data.providers) || [];
                            const enabledProviders = providers.filter(p => p.enabled);

                            if (enabledProviders.length === 0) {
                                container.innerHTML = '';
                                return;
                            }

                            let html = '<div class="oauth-buttons">';
                            enabledProviders.forEach(p => {
                                let providerClass = 'oauth';
                                if (p.provider_type === 'google') {
                                    providerClass = 'google';
                                } else if (p.provider_type === 'discord' || p.name.toLowerCase() === 'discord') {
                                    providerClass = 'discord';
                                }
                                const providerName = p.name || p.provider_type.charAt(0).toUpperCase() + p.provider_type.slice(1);
                                let iconSvg = '';
                                if (p.provider_type === 'google') {
                                    iconSvg = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>';
                                } else if (p.provider_type === 'discord' || p.name.toLowerCase() === 'discord') {
                                    iconSvg = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>';
                                } else {
                                    iconSvg = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>';
                                }
                                html += '<button type="button" class="btn oauth-btn ' + providerClass + '" data-provider-id="' + p.id + '">';
                                html += iconSvg;
                                html += '<span>Continue with ' + providerName + '</span></button>';
                            });
                            html += '</div>';
                            container.innerHTML = html;

                            container.querySelectorAll('.oauth-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const providerId = this.dataset.providerId;
                                    window.location.href = '/_auth/oauth/' + providerId;
                                });
                            });
                        })
                        .catch(function(err) {
                            console.error('Failed to load OAuth providers', err);
                        });
                }

                loadOAuthProviders();
            })();
        </script>
        <script>
            {{ if .ToastMessage }}
            showToast({{ .ToastMessage | js }});
            {{ if .Redirect }}
            setTimeout(function(){ window.location.href = {{ .Redirect | js }}; }, 1200);
            {{ end }}
            {{ end }}
        </script>
    </body>
 </html>
{{ end }}