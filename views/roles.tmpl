{{ define "roles" }}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="/img/logo.ico">
    <title>SparkProxy â€¢ Roles</title>
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/sidebar.css" />
    <link rel="stylesheet" href="/css/roles.css" />
</head>

<body class="page-roles">
    <div class="app">
        {{ template "sidebar" . }}
        {{ template "notifications" . }}

        <main class="content" role="main" aria-labelledby="page-title">
            <header class="page-header">
                <h1 id="page-title">Manage Roles</h1>
                <p class="subtitle">Define and manage user roles with specific permissions</p>
            </header>

            <section class="panel" aria-label="Roles">
                <div class="toolbar">
                    <div class="left">
                        <label class="input-icon" aria-label="Search roles">
                            <span class="icon" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"></circle>
                                    <path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                            <input type="search" placeholder="Search roles...">
                        </label>
                    </div>
                    <div class="right">
                        <button class="btn ghost" type="button" id="refresh-roles-btn">
                            <span class="icon orange" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="2"></path>
                                    <path d="M21 3v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                            <span>Refresh</span>
                        </button>
                        <button class="btn ghost" type="button" id="open-role-modal">
                            <span class="icon orange" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                            <span>Create Role</span>
                        </button>
                    </div>
                </div>

                <div class="table-wrap">
                    <table class="table roles-table" role="grid">
                        <thead>
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col">Description</th>
                                <th scope="col">Permissions</th>
                                <th scope="col">Type</th>
                                <th scope="col"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Roles will be populated from /api/roles -->
                        </tbody>
                    </table>
                </div>

                <div class="pager">
                    <div class="page-info">Page 1 of 1</div>
                    <div class="page-controls">
                        <button class="btn small ghost" aria-label="First page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M18 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                    <path d="M12 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" aria-label="Previous page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" aria-label="Next page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" aria-label="Last page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M6 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                    <path d="M12 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal-backdrop" id="role-modal" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="role-title">
            <div class="role-form">
                <h2 id="role-title">Create Role</h2>
                <form id="role-form">
                    <input type="hidden" name="originalName" id="role-original-name">
                    <div class="field-row">
                        <label>
                            <span>Name</span>
                            <input type="text" name="name" id="role-name" required />
                        </label>
                        <label>
                            <span>Description</span>
                            <input type="text" name="description" id="role-description" />
                        </label>
                    </div>
                    <div class="field-row permissions-row">
                        <label class="permissions-label">
                            <span>Permissions</span>
                            <span class="hint">Select at least one permission</span>
                        </label>
                        <div class="permissions-checkboxes" id="permissions-checkboxes">
                            <!-- Checkboxes will be populated dynamically -->
                        </div>
                    </div>
                    <div class="actions-row">
                        <button class="btn primary" type="submit">Save Role</button>
                        <button class="btn ghost" type="button" id="role-cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const form = document.getElementById('role-form');
            const tableBody = document.querySelector('.roles-table tbody');
            const searchInput = document.querySelector('.toolbar .input-icon input[type="search"]');
            const refreshBtn = document.getElementById('refresh-roles-btn');
            const openRoleBtn = document.getElementById('open-role-modal');
            const roleModal = document.getElementById('role-modal');
            const roleCancelBtn = document.getElementById('role-cancel-btn');
            const permissionsContainer = document.getElementById('permissions-checkboxes');
            const roleTitle = document.getElementById('role-title');
            const originalNameInput = document.getElementById('role-original-name');

            let allRoles = [];
            const allPermissions = [
                { value: 'view_dashboard', label: 'View Dashboard' },
                { value: 'view_analytics', label: 'View Analytics' },
                { value: 'view_logs', label: 'View Logs' },
                { value: 'manage_domains', label: 'Manage Domains' },
                { value: 'manage_users', label: 'Manage Users' },
                { value: 'manage_roles', label: 'Manage Roles' }
            ];

            function openModal(isEdit) {
                if (!roleModal) return;
                roleModal.hidden = false;
                if (isEdit) {
                    roleTitle.textContent = 'Edit Role';
                } else {
                    roleTitle.textContent = 'Create Role';
                    form.reset();
                    originalNameInput.value = '';
                    clearPermissions();
                }
            }

            function closeModal() {
                if (!roleModal) return;
                roleModal.hidden = true;
                if (form) {
                    form.reset();
                }
            }

            function clearPermissions() {
                if (!permissionsContainer) return;
                const checkboxes = permissionsContainer.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(function(cb) {
                    cb.checked = false;
                });
            }

            function populatePermissions(existingPerms) {
                if (!permissionsContainer) return;
                permissionsContainer.innerHTML = '';
                allPermissions.forEach(function(p) {
                    const label = document.createElement('label');
                    label.className = 'permission-checkbox';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.name = 'permissions';
                    cb.value = p.value;
                    if (existingPerms) {
                        cb.checked = existingPerms.indexOf(p.value) !== -1;
                    }
                    label.appendChild(cb);
                    label.appendChild(document.createTextNode(' ' + p.label));
                    permissionsContainer.appendChild(label);
                });
            }

            function formatPermissions(perms) {
                if (!perms || perms.length === 0) return 'None';
                return perms.map(function(p) {
                    return p.replace(/_/g, ' ').replace(/\b\w/g, function(c) {
                        return c.toUpperCase();
                    });
                }).join(', ');
            }

            function renderRoles() {
                if (!tableBody) return;
                const term = (searchInput && searchInput.value || '').toLowerCase();
                tableBody.innerHTML = '';
                allRoles
                    .filter(function(r) {
                        if (!term) return true;
                        const hay = (r.name + ' ' + (r.description || '')).toLowerCase();
                        return hay.indexOf(term) !== -1;
                    })
                    .forEach(function(r) {
                        const tr = document.createElement('tr');

                        function td(text) {
                            const cell = document.createElement('td');
                            cell.textContent = text || '';
                            return cell;
                        }

                        tr.appendChild(td(r.name));
                        tr.appendChild(td(r.description || '-'));
                        tr.appendChild(td(formatPermissions(r.permissions)));
                        tr.appendChild(td(r.is_system ? 'System' : 'Custom'));

                        const actions = document.createElement('td');
                        const editBtn = document.createElement('button');
                        editBtn.type = 'button';
                        editBtn.className = 'btn small ghost';
                        editBtn.textContent = 'Edit';
                        editBtn.addEventListener('click', function() {
                            openModal(true);
                            document.getElementById('role-name').value = r.name;
                            document.getElementById('role-name').readOnly = r.is_system;
                            document.getElementById('role-description').value = r.description || '';
                            originalNameInput.value = r.name;
                            populatePermissions(r.permissions);
                        });
                        actions.appendChild(editBtn);

                        const delBtn = document.createElement('button');
                        delBtn.type = 'button';
                        delBtn.className = 'btn small ghost';
                        delBtn.textContent = 'Delete';
                        if (r.is_system) {
                            delBtn.disabled = true;
                            delBtn.title = 'Cannot delete system roles';
                        }
                        delBtn.addEventListener('click', function() {
                            if (!confirm('Delete role ' + r.name + '?')) return;
                            fetch('/api/roles/' + encodeURIComponent(r.name), { method: 'DELETE' })
                                .then(function(res) { return res.json(); })
                                .then(function(data) {
                                    if (data && data.error) {
                                        alert(data.error);
                                        return;
                                    }
                                    loadRoles();
                                })
                                .catch(function(err) { console.error('Failed to delete role', err); });
                        });
                        actions.appendChild(delBtn);
                        tr.appendChild(actions);

                        tableBody.appendChild(tr);
                    });
            }

            function loadRoles() {
                fetch('/api/roles')
                    .then(function(r) { return r.ok ? r.json() : Promise.reject(r); })
                    .then(function(data) {
                        allRoles = (data && data.roles) || [];
                        renderRoles();
                    })
                    .catch(function(err) {
                        console.error('Failed to load /api/roles', err);
                        if (typeof showToast === 'function') {
                            showToast('Failed to load roles');
                        } else if (typeof alert === 'function') {
                            alert('Failed to load roles');
                        }
                    });
            }

            if (openRoleBtn) {
                openRoleBtn.addEventListener('click', function() {
                    openModal(false);
                    populatePermissions([]);
                });
            }

            if (roleCancelBtn) {
                roleCancelBtn.addEventListener('click', function() {
                    closeModal();
                });
            }

            if (roleModal) {
                roleModal.addEventListener('click', function(e) {
                    if (e.target === roleModal) {
                        closeModal();
                    }
                });
            }

            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const name = formData.get('name');
                    const description = formData.get('description') || '';
                    var permissions = [];
                    if (permissionsContainer) {
                        var checkboxes = permissionsContainer.querySelectorAll('input[name="permissions"]:checked');
                        Array.prototype.forEach.call(checkboxes, function(cb) {
                            permissions.push(cb.value);
                        });
                    }
                    if (permissions.length === 0) {
                        if (typeof showToast === 'function') {
                            showToast('Please select at least one permission');
                        } else {
                            alert('Please select at least one permission');
                        }
                        return;
                    }

                    const originalName = formData.get('originalName');
                    var method = 'POST';
                    var url = '/api/roles';
                    if (originalName && originalName !== '') {
                        method = 'PUT';
                        url = '/api/roles/' + encodeURIComponent(originalName);
                    }

                    fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: name,
                            description: description,
                            permissions: permissions
                        })
                    })
                        .then(function(r) {
                            var ct = r.headers.get('content-type') || '';
                            if (!ct.includes('application/json')) {
                                return r.text().then(function() {
                                    var msg = 'Unexpected response from server';
                                    if (typeof showToast === 'function') {
                                        showToast(msg);
                                    } else if (typeof alert === 'function') {
                                        alert(msg);
                                    }
                                    throw new Error(msg);
                                });
                            }
                            return r.json().then(function(data) {
                                if (!r.ok || (data && data.error)) {
                                    var msg2 = (data && data.error) || 'Failed to save role';
                                    if (typeof showToast === 'function') {
                                        showToast(msg2);
                                    } else if (typeof alert === 'function') {
                                        alert(msg2);
                                    }
                                    throw new Error(msg2);
                                }
                                return data;
                            });
                        })
                        .then(function() {
                            closeModal();
                            if (typeof showToast === 'function') {
                                showToast('Role saved successfully');
                            }
                            loadRoles();
                        })
                        .catch(function(err) {
                            console.error('Failed to save role', err);
                            if (typeof showToast === 'function') {
                                showToast('Failed to save role');
                            } else if (typeof alert === 'function') {
                                alert('Failed to save role');
                            }
                        });
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', renderRoles);
            }
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() { loadRoles(); });
            }

            loadRoles();
        })();
    </script>
</body>

</html>
{{ end }}
