{{ define "logs" }}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/img/logo.ico">
    <title>SparkProxy â€¢ Request Logs</title>
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/sidebar.css" />
    <link rel="stylesheet" href="/css/logs.css" />
</head>

<body class="page-logs">
    <div class="app">
        {{ template "sidebar" . }}

        <main class="content" role="main" aria-labelledby="page-title">
            <header class="page-header">
                <h1 id="page-title">Request Logs</h1>
                <p class="subtitle">View detailed request logs for resources</p>
            </header>

            <section class="panel" aria-label="Request Logs">
                <div class="toolbar">
                    <div class="left">
                        <label class="input-icon" aria-label="Search sites">
                            <span class="icon" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"></circle>
                                    <path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                            <input type="search" placeholder="Search sites...">
                        </label>
                    </div>
                    <div class="right">
                        <button class="btn ghost" type="button">
                            <span class="icon orange" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="2"></path>
                                    <path d="M21 3v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                            <span>Refresh</span>
                        </button>
                        <button class="btn ghost" type="button" id="export-btn">
                            <span class="icon orange" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </span>
                            <span>Export</span>
                        </button>
                        <select id="export-format" class="filter-select" style="margin-left: 8px; width: auto;">
                            <option value="csv">CSV</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>
                </div>

                <div class="table-wrap">
                    <table class="table" role="grid">
                        <thead>
                            <tr>
                                <th scope="col">Timestamp</th>
                                <th scope="col">Action</th>
                                <th scope="col">IP</th>
                                <th scope="col">Location</th>
                                <th scope="col">Host</th>
                                <th scope="col">Path</th>
                                <th scope="col">Method</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div class="pager">
                    <div class="page-info" id="page-info-text">Page 1 of 1</div>
                    <div class="page-controls">
                        <button class="btn small ghost" id="first-page-btn" aria-label="First page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M18 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                    <path d="M12 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" id="prev-page-btn" aria-label="Previous page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" id="next-page-btn" aria-label="Next page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                        <button class="btn small ghost" id="last-page-btn" aria-label="Last page">
                            <span class="icon" aria-hidden="true">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M6 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                    <path d="M12 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        (function () {
            const card = document.querySelector('.profile-card');
            if (!card) return;
            const img = card.querySelector('.avatar');
            const fallback = card.querySelector('.avatar-fallback');
            const nameEl = card.querySelector('.username');
            const initial = (nameEl && nameEl.textContent || '').trim().charAt(0).toUpperCase() || '?';
            if (fallback) { fallback.textContent = initial; }
            function showFallback() { if (img) { img.style.display = 'none'; } if (fallback) { fallback.style.display = 'grid'; } }
            if (!img || !img.getAttribute('src')) { showFallback(); }
            else { img.addEventListener('error', showFallback); }
        })();

        (function () {
            const tableBody = document.querySelector('.table tbody');
            if (!tableBody) return;

            const firstPageBtn = document.getElementById('first-page-btn');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');
            const lastPageBtn = document.getElementById('last-page-btn');
            const pageInfoText = document.getElementById('page-info-text');

            let currentPage = 1;
            let itemsPerPage = 20;
            let totalPages = 1;
            let totalItems = 0;

            function updatePager() {
                if (pageInfoText) {
                    pageInfoText.textContent = 'Page ' + currentPage + ' of ' + (totalPages || 1) + ' (' + totalItems + ' items)';
                }
                if (firstPageBtn) firstPageBtn.disabled = currentPage <= 1;
                if (prevPageBtn) prevPageBtn.disabled = currentPage <= 1;
                if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;
                if (lastPageBtn) lastPageBtn.disabled = currentPage >= totalPages;
            }

            function render() {
                fetch('/api/logs?page=' + currentPage + '&limit=' + itemsPerPage)
                    .then(r => r.ok ? r.json() : Promise.reject(r.status))
                    .then(data => {
                        const pagination = data.pagination || {};
                        currentPage = pagination.page || 1;
                        totalPages = pagination.total_pages || 1;
                        totalItems = pagination.total || 0;

                        const logs = (data && data.logs) || [];
                        tableBody.innerHTML = '';
                        logs.forEach(entry => {
                            const tr = document.createElement('tr');

                            const tdTs = document.createElement('td');
                            tdTs.textContent = entry.timestamp || '';

                            const tdAction = document.createElement('td');
                            tdAction.textContent = entry.action || '';

                            const tdIP = document.createElement('td');
                            tdIP.textContent = entry.ip || '';

                            const tdLoc = document.createElement('td');
                            tdLoc.textContent = entry.location || '';

                            const tdHost = document.createElement('td');
                            tdHost.textContent = entry.host || '';

                            const tdPath = document.createElement('td');
                            tdPath.textContent = entry.path || '';

                            const tdMethod = document.createElement('td');
                            tdMethod.textContent = entry.method || '';

                            tr.appendChild(tdTs);
                            tr.appendChild(tdAction);
                            tr.appendChild(tdIP);
                            tr.appendChild(tdLoc);
                            tr.appendChild(tdHost);
                            tr.appendChild(tdPath);
                            tr.appendChild(tdMethod);

                            tableBody.appendChild(tr);
                        });
                        updatePager();
                    })
                    .catch(err => {
                        console.error('Failed to load /api/logs', err);
                    });
            }

            render();

            const refreshBtn = document.querySelector('.toolbar .btn.ghost');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function () {
                    render();
                });
            }

            if (firstPageBtn) {
                firstPageBtn.addEventListener('click', function () {
                    if (currentPage > 1) {
                        currentPage = 1;
                        render();
                    }
                });
            }
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', function () {
                    if (currentPage > 1) {
                        currentPage--;
                        render();
                    }
                });
            }
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', function () {
                    if (currentPage < totalPages) {
                        currentPage++;
                        render();
                    }
                });
            }
            if (lastPageBtn) {
                lastPageBtn.addEventListener('click', function () {
                    if (currentPage < totalPages) {
                        currentPage = totalPages;
                        render();
                    }
                });
            }

            const exportBtn = document.getElementById('export-btn');
            const exportFormat = document.getElementById('export-format');

            function downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            function escapeCSV(str) {
                if (str === null || str === undefined) return '';
                const s = String(str);
                if (s.includes(',') || s.includes('"') || s.includes('\n')) {
                    return '"' + s.replace(/"/g, '""') + '"';
                }
                return s;
            }

            function exportLogs(format) {
                fetch('/api/logs?limit=10000')
                    .then(r => r.ok ? r.json() : Promise.reject(r.status))
                    .then(data => {
                        const logs = (data && data.logs) || [];
                        const date = new Date().toISOString().split('T')[0];
                        let content, filename, mimeType;

                        if (format === 'csv') {
                            const headers = ['Timestamp', 'Action', 'IP', 'Location', 'Host', 'Path', 'Method'];
                            let csv = headers.map(escapeCSV).join(',') + '\n';
                            logs.forEach(log => {
                                const row = [
                                    log.timestamp,
                                    log.action,
                                    log.ip,
                                    log.location,
                                    log.host,
                                    log.path,
                                    log.method
                                ];
                                csv += row.map(escapeCSV).join(',') + '\n';
                            });
                            content = csv;
                            filename = 'request-logs-' + date + '.csv';
                            mimeType = 'text/csv';
                        } else {
                            const exportData = {
                                exported_at: new Date().toISOString(),
                                total_logs: logs.length,
                                logs: logs
                            };
                            content = JSON.stringify(exportData, null, 2);
                            filename = 'request-logs-' + date + '.json';
                            mimeType = 'application/json';
                        }
                        downloadFile(content, filename, mimeType);
                    })
                    .catch(err => {
                        console.error('Failed to export logs', err);
                        alert('Failed to export logs');
                    });
            }

            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    const fmt = exportFormat ? exportFormat.value : 'csv';
                    exportLogs(fmt);
                });
            }
        })();
    </script>
</body>

</html>
{{ end }}