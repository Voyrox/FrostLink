{{ define "firewall" }}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="/img/logo.ico">
    <title>SparkProxy â€¢ Firewall</title>
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/sidebar.css" />
    <link rel="stylesheet" href="/css/dashboard.css" />
    <link rel="stylesheet" href="/css/firewall.css" />
</head>
<body class="page-firewall">
    <div class="app">
        {{ template "sidebar" . }}
        {{ template "notifications" . }}

        <main class="content" role="main" aria-labelledby="page-title">
            <header class="page-header">
                <h1 id="page-title">Firewall</h1>
                <p class="subtitle">Ban IPs and countries from accessing your proxies</p>
            </header>

            <section class="panel" aria-label="Firewall configuration">
                <div class="toolbar">
                    <div class="left">
                        <p class="subtitle">Create firewall rules to block abusive traffic before it reaches your upstreams.</p>
                    </div>
                    <div class="right">
                        <button class="btn ghost" type="button" id="refresh-firewall-btn">
                            <span class="icon orange" aria-hidden="true">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="2"></path>
                                    <path d="M21 3v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                </svg>
                            </span>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>

                <div class="table-wrap">
                    <div class="firewall-grid">
                        <div class="firewall-column">
                            <h2>Ban single IP</h2>
                            <p class="subtitle">Block a specific IPv4 or IPv6 address.</p>
                            <form id="ban-ip-form">
                                <label>
                                    <span>IP address</span>
                                    <input type="text" id="ban-ip-input" placeholder="e.g. 203.0.113.10 or 2001:db8::1" required />
                                </label>
                                <div class="actions-row">
                                    <button class="btn primary" type="submit">Ban IP</button>
                                </div>
                            </form>

                            <h2 style="margin-top:24px;">Upload IP list (.txt)</h2>
                            <p class="subtitle">Upload a text file with one IP per line for mass banning.</p>
                            <form id="ban-ip-upload-form" enctype="multipart/form-data">
                                <label>
                                    <span>IP list file</span>
                                    <input type="file" id="ban-ip-file" name="file" accept=".txt" />
                                </label>
                                <div class="actions-row">
                                    <button class="btn primary" type="submit">Upload &amp; ban</button>
                                </div>
                            </form>
                        </div>

                        <div class="firewall-column">
                            <h2>Ban by country</h2>
                            <p class="subtitle">Block traffic based on GeoIP country code.</p>
                            <form id="ban-country-form">
                                <label>
                                    <span>Country codes</span>
                                    <input type="text" id="ban-country-input" placeholder="e.g. US, AU, CN" />
                                </label>
                                <p class="hint">Use 2-letter ISO country codes, separated by commas.</p>
                                <div class="actions-row">
                                    <button class="btn primary" type="submit">Ban countries</button>
                                </div>
                            </form>

                            <h2 style="margin-top:24px;">Current bans</h2>
                            <div class="firewall-current">
                                <div>
                                    <h3>Banned IPs</h3>
                                    <ul id="banned-ips-list" class="firewall-list"></ul>
                                </div>
                                <div style="margin-top:16px;">
                                    <h3>Banned countries</h3>
                                    <ul id="banned-countries-list" class="firewall-list"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        (function () {
            if (typeof window.showToast !== 'function') {
                window.showToast = function (msg) { alert(msg); };
            }

            const refreshBtn = document.getElementById('refresh-firewall-btn');
            const banIpForm = document.getElementById('ban-ip-form');
            const banIpInput = document.getElementById('ban-ip-input');
            const banIpUploadForm = document.getElementById('ban-ip-upload-form');
            const banIpFile = document.getElementById('ban-ip-file');
            const banCountryForm = document.getElementById('ban-country-form');
            const banCountryInput = document.getElementById('ban-country-input');
            const bannedIpsList = document.getElementById('banned-ips-list');
            const bannedCountriesList = document.getElementById('banned-countries-list');

            function renderList(el, items) {
                if (!el) return;
                el.innerHTML = '';
                if (!items || !items.length) {
                    const li = document.createElement('li');
                    li.textContent = 'None';
                    li.className = 'muted';
                    el.appendChild(li);
                    return;
                }
                items.forEach(function (item) {
                    const li = document.createElement('li');
                    li.textContent = item;
                    el.appendChild(li);
                });
            }

            function loadFirewall() {
                fetch('/api/firewall')
                    .then(function (r) { return r.ok ? r.json() : Promise.reject(r); })
                    .then(function (data) {
                        renderList(bannedIpsList, (data && data.banned_ips) || []);
                        renderList(bannedCountriesList, (data && data.banned_countries) || []);
                    })
                    .catch(function () {
                        showToast('Failed to load firewall rules');
                    });
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', function () {
                    loadFirewall();
                });
            }

            if (banIpForm) {
                banIpForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const ip = (banIpInput && banIpInput.value || '').trim();
                    if (!ip) {
                        showToast('Enter an IP address to ban');
                        return;
                    }
                    fetch('/api/firewall/ban-ip', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ip: ip })
                    })
                        .then(function (r) { return r.json(); })
                        .then(function (data) {
                            if (data && data.error) {
                                showToast(data.error || 'Failed to ban IP');
                                return;
                            }
                            showToast('IP banned');
                            if (banIpInput) banIpInput.value = '';
                            loadFirewall();
                        })
                        .catch(function () { showToast('Failed to ban IP'); });
                });
            }

            if (banIpUploadForm) {
                banIpUploadForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    if (!banIpFile || !banIpFile.files || !banIpFile.files.length) {
                        showToast('Choose a .txt file with IPs');
                        return;
                    }
                    const fd = new FormData();
                    fd.append('file', banIpFile.files[0]);
                    fetch('/api/firewall/ban-ip-upload', {
                        method: 'POST',
                        body: fd
                    })
                        .then(function (r) { return r.json(); })
                        .then(function (data) {
                            if (data && data.error) {
                                showToast(data.error || 'Failed to upload IP list');
                                return;
                            }
                            const added = data && typeof data.added === 'number' ? data.added : 0;
                            showToast('Added ' + added + ' IPs to firewall');
                            if (banIpFile) banIpFile.value = '';
                            loadFirewall();
                        })
                        .catch(function () { showToast('Failed to upload IP list'); });
                });
            }

            if (banCountryForm) {
                banCountryForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const raw = (banCountryInput && banCountryInput.value || '').trim();
                    if (!raw) {
                        showToast('Enter at least one country code');
                        return;
                    }
                    const parts = raw.split(',').map(function (p) { return p.trim(); }).filter(function (p) { return p.length; });
                    if (!parts.length) {
                        showToast('Enter valid country codes');
                        return;
                    }
                    fetch('/api/firewall/ban-country', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ countries: parts })
                    })
                        .then(function (r) { return r.json(); })
                        .then(function (data) {
                            if (data && data.error) {
                                showToast(data.error || 'Failed to ban countries');
                                return;
                            }
                            const added = data && typeof data.added === 'number' ? data.added : 0;
                            showToast('Added ' + added + ' countries to firewall');
                            if (banCountryInput) banCountryInput.value = '';
                            loadFirewall();
                        })
                        .catch(function () { showToast('Failed to ban countries'); });
                });
            }

            loadFirewall();
        })();
    </script>
</body>
</html>
{{ end }}
