{{ define "firewall" }}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="/img/logo.ico">
    <title>SparkProxy â€¢ Firewall</title>
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/sidebar.css" />
    <link rel="stylesheet" href="/css/firewall.css" />
</head>
<body class="page-firewall">
    <div class="app">
        {{ template "sidebar" . }}
        {{ template "notifications" . }}

        <main class="content" role="main" aria-labelledby="page-title">
            <header class="page-header">
                <h1 id="page-title">Firewall</h1>
                <p class="subtitle">Block IPs and countries from accessing your proxies</p>
            </header>

            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-icon red">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L3 7v6c0 5.5 4 10 9 11 5-1 9-5.5 9-11V7l-9-5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value" id="stat-ips">0</span>
                        <span class="stat-label">Banned IPs</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value" id="stat-countries">0</span>
                        <span class="stat-label">Banned Countries</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M22 4L12 14.01l-3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value" id="stat-active">Active</span>
                        <span class="stat-label">Firewall Status</span>
                    </div>
                </div>
            </div>

            <section class="panel" aria-label="Firewall configuration">
                <div class="toolbar">
                    <div class="left">
                        <h2 class="toolbar-title">Firewall Rules</h2>
                        <p class="subtitle">Create rules to block abusive traffic before it reaches your upstreams.</p>
                    </div>
                    <div class="right">
                        <button class="btn ghost" type="button" id="refresh-firewall-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="2"></path>
                                <path d="M21 3v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                            </svg>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>

                <div class="firewall-grid">
                    <div class="firewall-column">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                        <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </div>
                                <div class="card-title-group">
                                    <h3>Ban Single IP</h3>
                                    <p class="subtitle">Block a specific IPv4 or IPv6 address</p>
                                </div>
                            </div>
                            <form id="ban-ip-form" class="card-form">
                                <div class="form-group">
                                    <label for="ban-ip-input">IP Address</label>
                                    <input type="text" id="ban-ip-input" placeholder="e.g. 203.0.113.10 or 2001:db8::1" />
                                </div>
                                <button class="btn primary full-width" type="submit">Ban IP</button>
                            </form>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="card-title-group">
                                    <h3>Upload IP List</h3>
                                    <p class="subtitle">Upload a .txt file with one IP per line</p>
                                </div>
                            </div>
                            <form id="ban-ip-upload-form" enctype="multipart/form-data" class="card-form">
                                <div class="form-group">
                                    <label for="ban-ip-file">IP List File</label>
                                    <input type="file" id="ban-ip-file" name="file" accept=".txt" />
                                </div>
                                <button class="btn primary full-width" type="submit">Upload & Ban</button>
                            </form>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                        <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </div>
                                <div class="card-title-group">
                                    <h3>Ban by Country</h3>
                                    <p class="subtitle">Block traffic based on GeoIP country</p>
                                </div>
                            </div>
                            <form id="ban-country-form" class="card-form">
                                <div class="form-group">
                                    <label for="ban-country-input">Country Codes</label>
                                    <input type="text" id="ban-country-input" placeholder="e.g. US, AU, CN (comma separated)" />
                                </div>
                                <p class="form-hint">Use 2-letter ISO country codes, separated by commas</p>
                                <button class="btn primary full-width" type="submit">Ban Countries</button>
                            </form>
                        </div>
                    </div>

                    <div class="firewall-column">
                        <div class="card card-full">
                            <div class="card-header">
                                <div class="card-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                        <path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </div>
                                <div class="card-title-group">
                                    <h3>Active Bans</h3>
                                    <p class="subtitle">Currently blocked IPs and countries</p>
                                </div>
                            </div>
                            <div class="bans-container">
                                <div class="bans-section">
                                    <div class="bans-header">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                            <path d="M15 9l-6 6M9 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        <span>Banned IPs</span>
                                        <span class="count-badge" id="ips-count">0</span>
                                    </div>
                                    <div id="banned-ips-list" class="bans-list">
                                        <span class="empty-state">No IPs banned</span>
                                    </div>
                                </div>
                                <div class="bans-section">
                                    <div class="bans-header">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                            <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke="currentColor" stroke-width="2"/>
                                        </svg>
                                        <span>Banned Countries</span>
                                        <span class="count-badge" id="countries-count">0</span>
                                    </div>
                                    <div id="banned-countries-list" class="bans-list">
                                        <span class="empty-state">No countries banned</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        (function () {
            if (typeof window.showToast !== 'function') {
                window.showToast = function (msg) { alert(msg); };
            }

            const refreshBtn = document.getElementById('refresh-firewall-btn');
            const banIpForm = document.getElementById('ban-ip-form');
            const banIpInput = document.getElementById('ban-ip-input');
            const banIpUploadForm = document.getElementById('ban-ip-upload-form');
            const banIpFile = document.getElementById('ban-ip-file');
            const banCountryForm = document.getElementById('ban-country-form');
            const banCountryInput = document.getElementById('ban-country-input');
            const bannedIpsList = document.getElementById('banned-ips-list');
            const bannedCountriesList = document.getElementById('banned-countries-list');
            const ipsCount = document.getElementById('ips-count');
            const countriesCount = document.getElementById('countries-count');
            const statIps = document.getElementById('stat-ips');
            const statCountries = document.getElementById('stat-countries');

            function renderList(el, items, isCountry) {
                if (!el) return;
                el.innerHTML = '';
                if (!items || !items.length) {
                    el.innerHTML = '<span class="empty-state">No ' + (isCountry ? 'countries' : 'IPs') + ' banned</span>';
                    return;
                }
                items.forEach(function (item) {
                    const chip = document.createElement('div');
                    chip.className = 'ban-chip';
                    chip.innerHTML = '<span>' + item + '</span><button type="button" class="remove-chip" title="Unban ' + item + '">&times;</button>';
                    chip.querySelector('.remove-chip').addEventListener('click', function() {
                        if (!confirm('Unban ' + item + '?')) return;
                        const endpoint = isCountry
                            ? '/api/firewall/country/' + encodeURIComponent(item)
                            : '/api/firewall/ip/' + encodeURIComponent(item);
                        fetch(endpoint, { method: 'DELETE' })
                            .then(function(r) { return r.json(); })
                            .then(function(data) {
                                if (data && data.error) {
                                    showToast(data.error || 'Failed to unban');
                                    return;
                                }
                                showToast('Unbanned ' + item);
                                loadFirewall();
                            })
                            .catch(function() { showToast('Failed to unban'); });
                    });
                    el.appendChild(chip);
                });
            }

            function loadFirewall() {
                fetch('/api/firewall')
                    .then(function (r) { return r.ok ? r.json() : Promise.reject(r); })
                    .then(function (data) {
                        const ips = (data && data.banned_ips) || [];
                        const countries = (data && data.banned_countries) || [];
                        renderList(bannedIpsList, ips, false);
                        renderList(bannedCountriesList, countries, true);
                        if (statIps) statIps.textContent = ips.length;
                        if (statCountries) statCountries.textContent = countries.length;
                        if (ipsCount) ipsCount.textContent = ips.length;
                        if (countriesCount) countriesCount.textContent = countries.length;
                    })
                    .catch(function () {
                        showToast('Failed to load firewall rules');
                    });
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', function () {
                    loadFirewall();
                });
            }

            if (banIpForm) {
                banIpForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const ip = (banIpInput && banIpInput.value || '').trim();
                    if (!ip) {
                        showToast('Enter an IP address to ban');
                        return;
                    }
                    fetch('/api/firewall/ban-ip', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ip: ip })
                    })
                        .then(function (r) { return r.json(); })
                        .then(function (data) {
                            if (data && data.error) {
                                showToast(data.error || 'Failed to ban IP');
                                return;
                            }
                            showToast('IP banned');
                            if (banIpInput) banIpInput.value = '';
                            loadFirewall();
                        })
                        .catch(function () { showToast('Failed to ban IP'); });
                });
            }

            if (banIpUploadForm) {
                banIpUploadForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    if (!banIpFile || !banIpFile.files || !banIpFile.files.length) {
                        showToast('Choose a .txt file with IPs');
                        return;
                    }
                    const fd = new FormData();
                    fd.append('file', banIpFile.files[0]);
                    fetch('/api/firewall/ban-ip-upload', {
                        method: 'POST',
                        body: fd
                    })
                        .then(function (r) { return r.json(); })
                        .then(function (data) {
                            if (data && data.error) {
                                showToast(data.error || 'Failed to upload IP list');
                                return;
                            }
                            const added = data && typeof data.added === 'number' ? data.added : 0;
                            showToast('Added ' + added + ' IPs to firewall');
                            if (banIpFile) banIpFile.value = '';
                            loadFirewall();
                        })
                        .catch(function () { showToast('Failed to upload IP list'); });
                });
            }

            if (banCountryForm) {
                banCountryForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const raw = (banCountryInput && banCountryInput.value || '').trim();
                    if (!raw) {
                        showToast('Enter at least one country code');
                        return;
                    }
                    const parts = raw.split(',').map(function (p) { return p.trim(); }).filter(function (p) { return p.length; });
                    if (!parts.length) {
                        showToast('Enter valid country codes');
                        return;
                    }
                    fetch('/api/firewall/ban-country', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ countries: parts })
                    })
                        .then(function (r) { return r.json(); })
                        .then(function (data) {
                            if (data && data.error) {
                                showToast(data.error || 'Failed to ban countries');
                                return;
                            }
                            const added = data && typeof data.added === 'number' ? data.added : 0;
                            showToast('Added ' + added + ' countries to firewall');
                            if (banCountryInput) banCountryInput.value = '';
                            loadFirewall();
                        })
                        .catch(function () { showToast('Failed to ban countries'); });
                });
            }

            loadFirewall();
        })();
    </script>
</body>
</html>
{{ end }}
