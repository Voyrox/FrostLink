{{ define "login" }}
<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/img/logo.ico">
        <title>SparkProxy • Authentication</title>
        <link rel="stylesheet" href="/css/global.css" />
        <link rel="stylesheet" href="/css/login.css" />
    </head>
    <body>
     {{ template "notifications" . }}
        <div class="page">
            <div class="powered">Powered by <strong>SparkProxy</strong></div>

            <main class="card" role="main" aria-labelledby="auth-title">
                <h1 id="auth-title">Authentication required</h1>
                <p class="subtitle">Choose your preferred method to log into SparkProxy</p>

                <div class="segmented" role="tablist" aria-label="Authentication method">
                    <div class="segmented-track">
                        <button class="segment is-active" role="tab" aria-selected="true" data-target="user" data-index="0">User</button>
                        <button class="segment" role="tab" aria-selected="false" data-target="pin" data-index="1">PIN</button>
                        <button class="segment" role="tab" aria-selected="false" data-target="passkey" data-index="2">Security key</button>
                        <span class="segment-indicator" aria-hidden="true"></span>
                    </div>
                </div>

                <form id="panel-user" class="panel is-active" autocomplete="on" novalidate method="post" action="/login">
                    <label for="email">Email</label>
                    <input id="email" name="email" type="email" inputmode="email" autocomplete="email" placeholder="name@example.com" required />

                    <label for="password">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" placeholder="••••••••" required />

                    <div class="row between">
                        <a class="link" href="#" aria-label="Forgot your password?">Forgot your password?</a>
                    </div>

                    <button type="submit" class="btn primary">Log in</button>
                    <button type="button" class="btn ghost" id="btn-passkey">Continue with security key</button>
                </form>

                <form id="panel-pin" class="panel" autocomplete="off" hidden>
                    <label for="pin">PIN</label>
                    <input id="pin" name="pin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="Enter PIN" />
                    <button type="submit" class="btn primary">Continue</button>
                </form>

                <div id="panel-passkey" class="panel" hidden>
                    <p>Use your device security key to continue.</p>
                    <button class="btn primary" type="button">Continue with security key</button>
                </div>
            </main>
        </div>

        <script>
            (function () {
                const track = document.querySelector('.segmented-track');
                const indicator = document.querySelector('.segment-indicator');
                const tabs = Array.from(document.querySelectorAll('.segment'));
                const panels = {
                    user: document.getElementById('panel-user'),
                    pin: document.getElementById('panel-pin'),
                    passkey: document.getElementById('panel-passkey'),
                };

                function activate(index) {
                    tabs.forEach((t, i) => {
                        const active = i === index;
                        t.classList.toggle('is-active', active);
                        t.setAttribute('aria-selected', String(active));
                    });

                    const target = tabs[index].dataset.target;
                    Object.entries(panels).forEach(([key, el]) => {
                        const show = key === target;
                        el.hidden = !show;
                        el.classList.toggle('is-active', show);
                    });

                    const width = track.getBoundingClientRect().width / tabs.length;
                    indicator.style.transform = `translateX(${index * width}px)`;
                    indicator.style.width = `${width}px`;
                }

                function initIndicator() {
                    const activeIdx = tabs.findIndex((t) => t.classList.contains('is-active')) || 0;
                    const width = track.getBoundingClientRect().width / tabs.length;
                    indicator.style.width = `${width}px`;
                    indicator.style.transform = `translateX(${activeIdx * width}px)`;
                }

                tabs.forEach((tab, i) => {
                    tab.addEventListener('click', () => activate(i));
                });

                window.addEventListener('resize', initIndicator);
                initIndicator();

                const passkeyBtn = document.getElementById('btn-passkey');
                if (passkeyBtn) {
                    passkeyBtn.addEventListener('click', () => activate(2));
                }
            })();
        </script>
        <script>
            {{ if .ToastMessage }}
            showToast({{ .ToastMessage | js }});
            {{ if .Redirect }}
            setTimeout(function(){ window.location.href = {{ .Redirect | js }}; }, 1200);
            {{ end }}
            {{ end }}
        </script>
    </body>
 </html>
{{ end }}